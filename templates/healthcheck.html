{% extends "base.html" %}

{% block title %}Health Check - VibeDispatch{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1">Health Check</h1>
        <p class="text-secondary mb-0">Monitor workflow status across all repositories</p>
    </div>
    <button class="btn btn-primary" onclick="loadWorkflowRuns()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-secondary mb-2 text-nowrap">Total Runs</h6>
                <h2 class="mb-0" id="stat-total">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-secondary mb-2 text-nowrap">Successful</h6>
                <h2 class="mb-0 text-success" id="stat-success">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-secondary mb-2 text-nowrap">Failed</h6>
                <h2 class="mb-0 text-danger" id="stat-failed">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-secondary mb-2 text-nowrap">In Progress</h6>
                <h2 class="mb-0 text-warning" id="stat-progress">-</h2>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-funnel"></i> Filters</span>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label text-secondary">VibeCheck Status</label>
                <select class="form-select" id="filter-vc" onchange="filterWorkflows()">
                    <option value="all">All Repos</option>
                    <option value="vc-installed">VC Installed</option>
                    <option value="vc-not-installed">VC Not Installed</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-secondary">Run Status</label>
                <select class="form-select" id="filter-status" onchange="filterWorkflows()">
                    <option value="all">All Status</option>
                    <option value="success">Success</option>
                    <option value="failure">Failed</option>
                    <option value="in_progress">In Progress</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-secondary">Workflow Name</label>
                <select class="form-select" id="filter-workflow" onchange="filterWorkflows()">
                    <option value="all">All Workflows</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-secondary">Quick Filters</label>
                <div>
                    <button class="btn btn-sm btn-outline-danger" onclick="showOnlyFailed()">
                        <i class="bi bi-exclamation-triangle"></i> Show Failed
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Runs Table -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-play-circle"></i> Recent Workflow Runs
        <span class="badge bg-secondary ms-2" id="runs-count">-</span>
    </div>
    <div class="card-body">
        <div id="workflow-runs-container">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-secondary mt-2">Loading workflow runs...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const owner = '{{ owner }}';
    let allWorkflowRuns = [];

    // Helper for authenticated fetch (uses getAdminKey from utils.js)
    async function authFetch(url, options = {}) {
        const adminKey = getAdminKey();
        const headers = options.headers || {};
        if (adminKey) {
            headers['X-User-Key'] = adminKey;
        }
        return fetch(url, { ...options, headers });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadWorkflowRuns();
    });

    async function loadWorkflowRuns() {
        const container = document.getElementById('workflow-runs-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-secondary mt-2">Loading workflow runs from all repos...</p>
            </div>
        `;

        try {
            const response = await authFetch((window.URL_PREFIX || '') + '/api/global-workflow-runs');
            const data = await response.json();
            
            if (data.success) {
                allWorkflowRuns = data.runs;
                
                // Populate workflow name filter
                const workflowNames = [...new Set(data.runs.map(r => r.workflowName))].sort();
                const workflowFilter = document.getElementById('filter-workflow');
                workflowFilter.innerHTML = '<option value="all">All Workflows</option>';
                for (const name of workflowNames) {
                    workflowFilter.innerHTML += `<option value="${name}">${name}</option>`;
                }
                
                updateStats(data.runs);
                renderWorkflowRuns(data.runs);
            } else {
                container.innerHTML = '<p class="text-danger">Failed to load workflow runs</p>';
            }
        } catch (error) {
            container.innerHTML = '<p class="text-danger">Error loading workflow runs</p>';
        }
    }
    
    function updateStats(runs) {
        document.getElementById('stat-total').textContent = runs.length;
        document.getElementById('stat-success').textContent = runs.filter(r => r.conclusion === 'success').length;
        document.getElementById('stat-failed').textContent = runs.filter(r => r.conclusion === 'failure').length;
        document.getElementById('stat-progress').textContent = runs.filter(r => r.status === 'in_progress').length;
        document.getElementById('runs-count').textContent = runs.length;
    }
    
    function filterWorkflows() {
        const vcFilter = document.getElementById('filter-vc').value;
        const statusFilter = document.getElementById('filter-status').value;
        const workflowFilter = document.getElementById('filter-workflow').value;
        
        let filtered = allWorkflowRuns;
        
        if (vcFilter === 'vc-installed') {
            filtered = filtered.filter(r => r.vibecheck_installed);
        } else if (vcFilter === 'vc-not-installed') {
            filtered = filtered.filter(r => !r.vibecheck_installed);
        }
        
        if (statusFilter !== 'all') {
            filtered = filtered.filter(r => {
                const status = (r.conclusion || r.status || '').toLowerCase();
                return status === statusFilter;
            });
        }
        
        if (workflowFilter !== 'all') {
            filtered = filtered.filter(r => r.workflowName === workflowFilter);
        }
        
        updateStats(filtered);
        renderWorkflowRuns(filtered);
    }
    
    function showOnlyFailed() {
        document.getElementById('filter-status').value = 'failure';
        filterWorkflows();
    }
    
    function renderWorkflowRuns(runs) {
        const container = document.getElementById('workflow-runs-container');
        
        if (runs.length === 0) {
            container.innerHTML = '<p class="text-secondary text-center py-4">No workflow runs found matching filters</p>';
            return;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Repository</th>
                            <th>Workflow</th>
                            <th>Status</th>
                            <th>VC</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const run of runs) {
            const statusClass = run.conclusion === 'success' ? 'bg-success' : 
                               run.conclusion === 'failure' ? 'bg-danger' : 
                               run.status === 'in_progress' ? 'bg-warning' : 'bg-secondary';
            const statusText = run.conclusion || run.status || 'unknown';
            const vcBadge = run.vibecheck_installed ? 
                '<i class="bi bi-check-circle-fill text-success"></i>' : 
                '<i class="bi bi-dash-circle text-warning"></i>';
            const timeAgo = formatTimeAgo(run.createdAt);
            const rowClass = run.conclusion === 'failure' ? 'table-danger-subtle' : '';
            
            html += `
                <tr class="${rowClass}">
                    <td>
                        <a href="${window.URL_PREFIX || ''}/repo/${owner}/${run.repo}" class="text-decoration-none">
                            ${run.repo}
                        </a>
                    </td>
                    <td class="text-light">${run.workflowName || 'Unknown'}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${vcBadge}</td>
                    <td class="text-secondary">${timeAgo}</td>
                    <td>
                        <a href="https://github.com/${owner}/${run.repo}/actions/runs/${run.databaseId}" 
                           target="_blank" class="btn btn-sm btn-outline-primary" title="View on GitHub">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                        ${run.conclusion === 'failure' ? `
                            <a href="https://github.com/${owner}/${run.repo}/actions/runs/${run.databaseId}" 
                               target="_blank" class="btn btn-sm btn-outline-danger ms-1" title="View Logs">
                                <i class="bi bi-file-text"></i>
                            </a>
                        ` : ''}
                    </td>
                </tr>
            `;
        }
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
</script>
{% endblock %}
