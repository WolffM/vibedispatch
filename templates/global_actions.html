{% extends "base.html" %}

{% block title %}Global Actions - VibeDispatch{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1">Global Actions</h1>
        <p class="text-secondary mb-0">Pipeline stages across all repositories</p>
    </div>
</div>

<!-- Stage Tabs -->
<ul class="nav nav-tabs mb-4" id="stageTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stage1-tab" data-bs-toggle="tab" data-bs-target="#stage1" type="button" role="tab">
            <span class="badge bg-primary me-2">1</span> Install VibeCheck
            <span class="badge bg-secondary ms-2" id="stage1-count">-</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="stage2-tab" data-bs-toggle="tab" data-bs-target="#stage2" type="button" role="tab">
            <span class="badge bg-primary me-2">2</span> Run VibeCheck
            <span class="badge bg-secondary ms-2" id="stage2-count">-</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="stage3-tab" data-bs-toggle="tab" data-bs-target="#stage3" type="button" role="tab">
            <span class="badge bg-primary me-2">3</span> Assign Copilot
            <span class="badge bg-secondary ms-2" id="stage3-count">-</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="stage4-tab" data-bs-toggle="tab" data-bs-target="#stage4" type="button" role="tab">
            <span class="badge bg-primary me-2">4</span> Review & Merge
            <span class="badge bg-secondary ms-2" id="stage4-count">-</span>
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="stageTabContent">
    
    <!-- Stage 1: Install VibeCheck -->
    <div class="tab-pane fade show active" id="stage1" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-download"></i> Repos Without VibeCheck</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="loadStage1()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button class="btn btn-sm btn-success" onclick="installSelectedStage1()">
                        <i class="bi bi-download"></i> Install Selected
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="stage1-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-secondary mt-2">Loading repos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stage 2: Run VibeCheck -->
    <div class="tab-pane fade" id="stage2" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-play-fill"></i> Repos Ready to Run VibeCheck</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="loadStage2()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="runSelectedStage2()">
                        <i class="bi bi-play-fill"></i> Run Selected
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="stage2-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-secondary mt-2">Loading repos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stage 3: Assign Copilot -->
    <div class="tab-pane fade" id="stage3" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-robot"></i> Issues Ready for Copilot</span>
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" id="stage3-severity-filter" style="width: auto;" onchange="filterStage3()">
                        <option value="all">All Severity</option>
                        <option value="severity:critical">Critical</option>
                        <option value="severity:high">High</option>
                        <option value="severity:medium">Medium</option>
                        <option value="severity:low">Low</option>
                    </select>
                    <select class="form-select form-select-sm" id="stage3-label-filter" style="width: auto;" onchange="filterStage3()">
                        <option value="all">All Labels</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadStage3()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="assignSelectedStage3()">
                        <i class="bi bi-robot"></i> Assign Selected
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="stage3-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-secondary mt-2">Loading issues...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stage 4: Review & Merge -->
    <div class="tab-pane fade" id="stage4" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-git"></i> Pull Requests Ready for Review</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadStage4()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="stage4-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-secondary mt-2">Loading pull requests...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PR Detail Modal -->
<div class="modal fade" id="prModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary py-2">
                <div class="d-flex align-items-center">
                    <!-- PR navigation -->
                    <div id="prNav" class="me-3">
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="showPrevPR()" title="Previous PR" id="prevPRBtn">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span class="text-secondary mx-2" id="prCounter">1/5</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showNextPR()" title="Next PR" id="nextPRBtn">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div>
                        <h5 class="modal-title text-light mb-0" id="prModalTitle">Pull Request</h5>
                        <small class="text-secondary" id="prModalSubtitle"></small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" style="overflow: hidden;">
                <div class="row g-0 h-100">
                    <!-- Left sidebar: PR info -->
                    <div class="col-md-3 border-end border-secondary p-3" style="overflow-y: auto; max-height: calc(100vh - 130px);">
                        <div id="prModalInfo">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Right: Diff view -->
                    <div class="col-md-9 p-0" style="overflow-y: auto; max-height: calc(100vh - 130px);">
                        <div id="prModalDiff" class="p-3">
                            <div class="text-center py-4 text-secondary">
                                Loading diff...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary py-2">
                <div class="me-auto">
                    <span id="prStats" class="text-secondary"></span>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="prApproveBtn" onclick="approveCurrentPR()">
                    <i class="bi bi-check-lg"></i> Approve
                </button>
                <button type="button" class="btn btn-primary" id="prMergeBtn" onclick="mergeCurrentPR()">
                    <i class="bi bi-git"></i> Merge
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Log -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-terminal"></i> Progress Log</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">Clear</button>
    </div>
    <div class="card-body">
        <div id="progress-log" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
            <p class="text-secondary">Actions will be logged here...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/global-actions.js') }}"></script>
<script>
    function switchToStageFromHash() {
        const hash = window.location.hash;
        if (hash && hash.match(/^#stage[1-4]$/)) {
            const tabId = hash.substring(1) + '-tab';
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                const tab = new bootstrap.Tab(tabEl);
                tab.show();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initGlobalActions('{{ owner }}');
        switchToStageFromHash();
    });

    // Handle hash changes when already on the page
    window.addEventListener('hashchange', switchToStageFromHash);
</script>
{% endblock %}
